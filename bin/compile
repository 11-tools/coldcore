#!/usr/bin/env python3
"""
Used to compile the `src/` files into a single executable Python script
that's still decently auditable.
"""

from pathlib import Path
import re


def render_file():
    src = Path("src/coldcore")
    cc = (src / "main.py").read_bytes().splitlines()
    newlines = []

    for line in cc:
        third_match = re.search(b"^from \.thirdparty\.(?P<name>\\S+) import", line)
        match = re.search(b"^from \.(?P<name>\\S+) import", line)

        if third_match:
            contents = (
                Path(src / "thirdparty" / "{}.py".format(third_match.group(1).decode()))
                .read_bytes()
                .splitlines()
            )
            newlines.extend([b"\n", *contents, b"\n"])
        elif match:
            contents = (
                Path(src / "{}.py".format(match.group(1).decode()))
                .read_bytes()
                .splitlines()
            )
            newlines.extend([b"\n", *contents, b"\n"]) 
        else:
            newlines.append(line)

    Path("coldcore").write_bytes(b"\n".join(newlines))


if __name__ == "__main__":
    render_file()
